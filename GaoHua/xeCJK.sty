%%
%% This is file `xeCJK.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% xeCJK.dtx  (with options: `xeCJK')
%%
%%  Version 2.4.5 (31-Jan-2012)
%%
%%  Copyright (C) Wenchang Sun <sunwch@hotmail.com>
%%
%%  This file may be distributed and/or modified under the
%%  conditions of the LaTeX Project Public License, either version 1.3
%%  of this license or (at your option) any later version.
%%  The latest version of this license is in
%%    http://www.latex-project.org/lppl.txt
%%  and version 1.3 or later is part of all distributions of LaTeX
%%  version 2005/12/01 or later.
%%
\RequirePackage{expl3,l3keys2e}
\ProvidesExplPackage {xeCJK} {2012/01/31} {2.4.5}
  {package for typesetting CJK scripts with XeLaTeX}
\xetex_if_engine:F {
  \PackageError { xeCJK } {^^J
    The~ xeCJK~ package~ requires~ XeTeX~ to~ function.^^J
    You~ must~ change~ your~ typesetting~ engine~ to~ "xelatex"^^J
    instead~ of~ plain~ "latex"~ or~ "pdflatex".
  }
  \endinput
}

\tl_set:cn { ver@CJK.sty } { 2020/01/01 }

\tex_endlinechar:D \c_minus_one

\bool_new:N \g_xeCJK_AutoFakeBold_bool
\bool_new:N \l_xeCJK_AutoFakeBold_bool
\bool_new:N \g_xeCJK_AutoFakeItalic_bool
\bool_new:N \l_xeCJK_AutoFakeItalic_bool
\bool_new:N \g_xeCJK_AutoFakeSlant_bool
\bool_new:N \l_xeCJK_AutoFakeSlant_bool
\bool_new:N \g_xeCJK_AutoFallBack_bool
\bool_new:N \l_xeCJK_number_bool
\bool_new:N \l_xeCJK_space_bool
\bool_new:N \l_xeCJK_checksingle_bool

\fp_new:N \g_xeCJK_EmboldenFactor_fp
\fp_new:N \l_xeCJK_EmboldenFactor_fp
\fp_new:N \g_xeCJK_ItalicFactor_fp
\fp_new:N \l_xeCJK_ItalicFactor_fp
\fp_new:N \g_xeCJK_SlantFactor_fp
\fp_new:N \l_xeCJK_SlantFactor_fp

\clist_set:Nx \g_xeCJK_punctstyle_clist
  { CCT , halfwidth , fullwidth , marginkerning , mixedwidth , plain }
\clist_map_inline:Nn \g_xeCJK_punctstyle_clist
  { \tl_const:cn { c_xeCJK_ps_#1_tl } { #1 } }

\keys_define:nn { xeCJK } {
  AutoFakeBold .choice:,
  AutoFakeBold / true    .code:n = { \bool_set_true:N  \g_xeCJK_AutoFakeBold_bool },
  AutoFakeBold / false   .code:n = { \bool_set_false:N \g_xeCJK_AutoFakeBold_bool },
  AutoFakeBold / unknown .code:n = { \bool_set_true:N  \g_xeCJK_AutoFakeBold_bool
    \fp_set:Nn \g_xeCJK_EmboldenFactor_fp {\l_keys_value_tl} },
  AutoFakeBold .default:n  = { true },
  AutoFakeItalic .choice:,
  AutoFakeItalic / true     .code:n = { \bool_set_true:N  \g_xeCJK_AutoFakeItalic_bool },
  AutoFakeItalic / false    .code:n = { \bool_set_false:N \g_xeCJK_AutoFakeItalic_bool },
  AutoFakeItalic / unknown  .code:n = {
    \bool_set_true:N  \g_xeCJK_AutoFakeItalic_bool
    \fp_set:Nn \g_xeCJK_ItalicFactor_fp {\l_keys_value_tl } },
  AutoFakeSlant .default:n  = { true },
  AutoFakeSlant .choice:,
  AutoFakeSlant / true     .code:n = { \bool_set_true:N  \g_xeCJK_AutoFakeSlant_bool },
  AutoFakeSlant / false    .code:n = { \bool_set_false:N \g_xeCJK_AutoFakeSlant_bool },
  AutoFakeSlant / unknown  .code:n = {
    \bool_set_true:N  \g_xeCJK_AutoFakeSlant_bool
    \fp_set:Nn \g_xeCJK_SlantFactor_fp {\l_keys_value_tl } },
  AutoFakeSlant .default:n  = { true },
  AutoFallBack .choice:,
  AutoFallBack / true  .code:n = {
    \bool_set_true:N \g_xeCJK_AutoFallBack_bool
    \cs_if_exist_use:N \xeCJKenablefallback },
  AutoFallBack / false .code:n = {
    \bool_set_false:N \g_xeCJK_AutoFallBack_bool
    \cs_if_exist_use:N \xeCJKdisablefallback },
  AutoFallBack .default:n  = { true },
  EmboldenFactor .fp_set:N = \g_xeCJK_EmboldenFactor_fp,
  ItalicFactor   .fp_set:N = \g_xeCJK_ItalicFactor_fp,
  SlantFactor    .fp_set:N = \g_xeCJK_SlantFactor_fp,
  BoldFont  .meta:n = { AutoFakeBold  = #1 },
  boldfont  .meta:n = { AutoFakeBold  = #1 },
  SlantFont .meta:n = { AutoFakeSlant = #1 },
  slantfont .meta:n = { AutoFakeSlant = #1 },
  FallBack  .meta:n = { AutoFallBack  = #1 },
  fallback  .meta:n = { AutoFallBack  = #1 },
  BoldFont  .default:n  = { true },
  boldfont  .default:n  = { true },
  SlantFont .default:n  = { true },
  slantfont .default:n  = { true },
  FallBack  .default:n  = { true },
  fallback  .default:n  = { true },
  xeCJKactive .choice:,
  xeCJKactive / true  .code:n = { \XeTeXinterchartokenstate = \c_one },
  xeCJKactive / false .code:n = { \XeTeXinterchartokenstate = \c_zero },
  xeCJKactive .default:n  = { true },
  CJKnumber .choice:,
  CJKnumber / true  .code:n = { \bool_set_true:N \l_xeCJK_number_bool },
  CJKnumber / false .code:n = { \bool_set_false:N \l_xeCJK_number_bool },
  CJKnumber .default:n  = { true },
  CJKspace .choice:,
  CJKspace / true  .code:n = { \bool_set_true:N \l_xeCJK_space_bool },
  CJKspace / false .code:n = { \bool_set_false:N \l_xeCJK_space_bool },
  CJKspace .default:n  = { true },
  CJKallowbreakbetweenpuncts .choice:,
  CJKallowbreakbetweenpuncts / true  .code:n = {
    \cs_set_nopar:Nn \xeCJK_punct_nobreak: { \skip_horizontal:N \c_zero_skip } },
  CJKallowbreakbetweenpuncts / false .code:n = {
    \cs_set_eq:NN \xeCJK_punct_nobreak: \nobreak },
  CJKallowbreakbetweenpuncts .default:n  = { true },
  indentfirst .choice:,
  indentfirst / true  .code:n = { \cs_set_eq:NN \if@afterindent \if_false: },
  indentfirst / false .code:n = { \cs_set_eq:NN \@afterindentfalse \scan_stop: },
  indentfirst .default:n  = { true },
  normalindentfirst .meta:n = { indentfirst = false },
  KaiMingPunct  .tl_set_x:N = \l_xeCJK_kaimingpunct_tl ,
  CJKecglue     .tl_set_x:N = \CJKecglue ,
  KaiMingPunct+ .code:n = { \tl_put_right:Nx \l_xeCJK_kaimingpunct_tl { #1 } },
  KaiMingPunct- .code:n = { \tl_set:Nx \l_tmpa_tl { #1 }
    \tl_map_inline:Nn \l_tmpa_tl { \tl_remove_all:Nn \l_xeCJK_kaimingpunct_tl { ##1 } } },
  SpecialPunct  .tl_set_x:N = \l_xeCJK_specialpunct_tl ,
  SpecialPunct+ .code:n = { \tl_put_right:Nx \l_xeCJK_specialpunct_tl { #1 } },
  SpecialPunct- .code:n = {
    \tl_set:Nx \l_tmpa_tl { #1 }
    \tl_map_inline:Nn \l_tmpa_tl { \tl_remove_all:Nn \l_xeCJK_specialpunct_tl { ##1 } } },
  CJKchecksingle .choice:,
  CJKchecksingle / true  .code:n = { \bool_set_true:N  \l_xeCJK_checksingle_bool },
  CJKchecksingle / false .code:n = { \bool_set_false:N \l_xeCJK_checksingle_bool },
  CJKchecksingle .default:n  = { true },
  PunctStyle .choice_code:n = {
    \tl_set:Nx \l_xeCJK_punctstyle_tl { \l_keys_choice_tl }
    \tl_if_eq:NNT \l_keys_choice_tl \c_xeCJK_ps_plain_tl
      { \keys_set:nn { xeCJK } { CJKallowbreakbetweenpuncts = true } } },
  PunctStyle .generate_choices:n = {
    CCT , halfwidth , fullwidth , marginkerning , mixedwidth , plain },
  PunctStyle / banjiao       .meta:n = { PunctStyle = halfwidth },
  PunctStyle / quanjiao      .meta:n = { PunctStyle = fullwidth },
  PunctStyle / kaiming       .meta:n = { PunctStyle = mixedwidth },
  PunctStyle / hangmobanjiao .meta:n = { PunctStyle = marginkerning },
  PunctStyle .default:n  = { fullwidth },
  PunctStyle / unknown .code:n = {
    \PackageError { xeCJK } { Punctstyle~ "\l_keys_value_tl"~ is~ not~ defined. } },
  unknown .code:n = { \PassOptionsToPackage { \l_keys_key_tl } { fontspec } },
}

\keys_set:nn { xeCJK } {
  xeCJKactive = true , CJKallowbreakbetweenpuncts = false ,
  indentfirst = true , CJKspace = false , PunctStyle = quanjiao ,
  EmboldenFactor = 4 , ItalicFactor = .167 , SlantFactor = .167 ,
  KaiMingPunct = { ． 。？ ！ } , SpecialPunct = { — … ─ } ,
  CJKecglue = { ~ }
}

\ProcessKeysOptions { xeCJK }

\RequirePackage { fontspec }

\NewDocumentCommand \xeCJKsetup { m } { \keys_set:nn { xeCJK } { #1 } }

\NewDocumentCommand \CJKspace { }
  { \keys_set:nn { xeCJK } { CJKspace = true } }
\NewDocumentCommand \CJKnospace { }
  { \keys_set:nn { xeCJK } { CJKspace = false } }
\NewDocumentCommand \makexeCJKactive { }
  { \keys_set:nn { xeCJK } { xeCJKactive = true } }
\NewDocumentCommand \makexeCJKinactive { }
  { \keys_set:nn { xeCJK } { xeCJKactive = false } }
\NewDocumentCommand \xeCJKallowbreakbetweenpuncts { }
  { \keys_set:nn { xeCJK } { CJKallowbreakbetweenpuncts = true } }
\NewDocumentCommand \xeCJKnobreakbetweenpuncts { }
  { \keys_set:nn { xeCJK } { CJKallowbreakbetweenpuncts = false } }
\NewDocumentCommand \DeclareKaiMingPunct { t+ t- m } {
  \IfBooleanTF { #1 }
    { \keys_set:nn { xeCJK } { KaiMingPunct+ = { #3 } } }
    { \IfBooleanTF { #2 }
        { \keys_set:nn { xeCJK } { KaiMingPunct- = { #3 } } }
        { \keys_set:nn { xeCJK } { KaiMingPunct  = { #3 } } } } }
\NewDocumentCommand \DeclareSpecialPunct { t+ t- m } {
  \IfBooleanTF { #1 }
    { \keys_set:nn { xeCJK } { SpecialPunct+ = { #3 } } }
    { \IfBooleanTF { #2 }
        { \keys_set:nn { xeCJK } { SpecialPunct- = { #3 } } }
        { \keys_set:nn { xeCJK } { SpecialPunct  = { #3 } } } } }
\NewDocumentCommand \xeCJKsetEmboldenFactor { m }
  { \keys_set:nn { xeCJK } { EmboldenFactor = { #1 } } }
\NewDocumentCommand \xeCJKsetItaticFactor { m }
  { \keys_set:nn { xeCJK } { ItaticFactor = { #1 } } }
\NewDocumentCommand \xeCJKsetSlantFactor { m }
  { \keys_set:nn { xeCJK } { SlantFactor = { #1 } } }
\NewDocumentCommand \punctstyle { m }
  { \keys_set:nn { xeCJK } { PunctStyle = { #1 } } }
\cs_new_nopar:Npn \xeCJKplainchr { \punctstyle { plain } }

\NewDocumentCommand \CJKsetecglue { m }
  { \keys_set:nn { xeCJK } { CJKecglue = { #1 } } }

\cs_set_eq:NN \xeCJKsetecglue \CJKsetecglue

\cs_new_nopar:Nn \xeCJK_patch:Nnn
  { \tl_put_left:Nn  #1 { #2 }  \tl_put_right:Nn #1 { #3 } }

\AtBeginDocument {
  \clist_map_inline:nn {
    \textellipsis, \textemdash, \textperiodcentered, \textcentereddot,
    \textquoteleft, \textquoteright, \textquotedblleft, \textquotedblright
  }{
    \xeCJK_patch:Nnn #1 { \group_begin: \makexeCJKinactive } { \group_end: }
  }
  \xeCJK_patch:Nnn \tipaencoding { \makexeCJKinactive } { } % tipa package in T3 encoding
  \cs_set_eq:NN \xeCJK_aux_r \r
  \cs_set_nopar:Npn \r #1 {
    \group_begin:
      \makexeCJKinactive \xeCJK_aux_r { #1 }
    \group_end:
  } % \r{u} in T1 encoding
  \@ifpackageloaded { pifont } { % pifont package in U encoding
    \RenewDocumentCommand \Pifont { m } {
      \fontfamily { #1 } \fontencoding { U } \fontseries { m } \fontshape { n }
      \selectfont \makexeCJKinactive
    }
  }{ }
}

\NewDocumentCommand \xeCJKsetcharclass { m m m } {
  \int_set:Nn \l_tmpa_int { #1 }
  \int_set:Nn \l_tmpb_int { #3 }
  \int_do_while:nn { \l_tmpa_int <= #2 } {
    \XeTeXcharclass \l_tmpa_int = \l_tmpb_int
    \int_incr:N \l_tmpa_int
  }
  \xeCJK_setpunctcharclass:
}

\cs_new_nopar:Nn \xeCJK_setPunct:nnn {
  \int_set:Nn \l_tmpa_int { #1 }
  \int_set:Nn \l_tmpb_int { "#2 * \c_two_hundred_fifty_six }
  \clist_map_inline:nn { #3 } {
    \XeTeXcharclass \int_eval:n { \l_tmpb_int + "##1 } = \l_tmpa_int
  }
}
\cs_new_nopar:Nn \xeCJK_prePunct:nn
  { \xeCJK_setPunct:nnn \c_two { #1 } { #2 } }
\cs_new_nopar:Nn \xeCJK_postPunct:nn
  { \xeCJK_setPunct:nnn \c_three { #1 } { #2 } }

\cs_new_nopar:Nn \xeCJK_setpunctcharclass: {
  \xeCJK_prePunct:nn  { 20 } { 18, 1C }
  \xeCJK_postPunct:nn { 20 } { 19, 1D, 14, 26 }
  \xeCJK_postPunct:nn { 25 } { 00 }
  \xeCJK_prePunct:nn  { 30 } { 08, 0A, 0C, 0E, 10, 12, 14, 16, 18, 1A, 1D, 1F, 36 }
  \xeCJK_postPunct:nn { 30 } { 01, 02, 05, 06, 09, 0B, 0D, 0F, 11, 15, 17, 19,
      1B, 1E, 41, 43, 45, 47, 49, 63, 83, 85, 87, 8E, 9B, 9C, 9D, 9E, A1, A3, A5,
      A7, A9, C3, E3, E5, E7, EE, F5, F6, FB, FC, FD, FE }
  \xeCJK_prePunct:nn  { FE } { 59, 5B, 5D, 5F, 60, 69, 6B }
  \xeCJK_postPunct:nn { FE } { 50, 51, 52, 54, 55, 56, 57, 5A, 5C, 5E, 6A }
  \xeCJK_prePunct:nn  { FF } { 03, 04, 08, 20, 3B, 5B, E0, E1, E5, E6 }
  \xeCJK_postPunct:nn { FF } { 01, 05, 09, 0C, 0E, 1A, 1B, 1F, 3D, 5D, 61, 63, 64,
      65, 67, 68, 69, 6A, 6B, 6C, 6D, 6E, 6F, 70, 9E, 9F }
  \xeCJK_setPunct:nnn \c_one  { 0 } { B7 }
  \xeCJK_setPunct:nnn \c_four { 0 } { 28, 2D, 5B, 60, 7B }
  \xeCJK_setPunct:nnn \c_five { 0 } { 21, 22, 25, 27, 29, 2C, 2E, 3A, 3B, 3F, 5D, 7D }
}

\xeCJKsetcharclass { "1100 }  { "11FF }  { \c_one }
\xeCJKsetcharclass { "2E80 }  { "2EFF }  { \c_one }
\xeCJKsetcharclass { "2F00 }  { "2FDF }  { \c_one }
\xeCJKsetcharclass { "2FF0 }  { "2FFF }  { \c_one }
\xeCJKsetcharclass { "3000 }  { "303F }  { \c_one }
\xeCJKsetcharclass { "3040 }  { "309F }  { \c_one }
\xeCJKsetcharclass { "30A0 }  { "30FF }  { \c_one }
\xeCJKsetcharclass { "3100 }  { "312F }  { \c_one }
\xeCJKsetcharclass { "3130 }  { "318F }  { \c_one }
\xeCJKsetcharclass { "3190 }  { "319F }  { \c_one }
\xeCJKsetcharclass { "31A0 }  { "31BF }  { \c_one }
\xeCJKsetcharclass { "31C0 }  { "31EF }  { \c_one }
\xeCJKsetcharclass { "31F0 }  { "31FF }  { \c_one }
\xeCJKsetcharclass { "3200 }  { "32FF }  { \c_one }
\xeCJKsetcharclass { "3300 }  { "33FF }  { \c_one }
\xeCJKsetcharclass { "3400 }  { "4DBF }  { \c_one }
\xeCJKsetcharclass { "4E00 }  { "9FFF }  { \c_one }
\xeCJKsetcharclass { "A000 }  { "A4CF }  { \c_one }
\xeCJKsetcharclass { "AC00 }  { "D7AF }  { \c_one }
\xeCJKsetcharclass { "F900 }  { "FAFF }  { \c_one }
\xeCJKsetcharclass { "FE30 }  { "FE4F }  { \c_one }
\xeCJKsetcharclass { "FF00 }  { "FFEF }  { \c_one }
\xeCJKsetcharclass { "20000 } { "2A6DF } { \c_one }
\xeCJKsetcharclass { "2A700 } { "2B73F } { \c_one }
\xeCJKsetcharclass { "2B740 } { "2B81F } { \c_one }
\xeCJKsetcharclass { "2F800 } { "2FA1F } { \c_one }

\NewDocumentCommand \normalspacedchars { m }
  { \tl_map_inline:nn { #1 } { \XeTeXcharclass `##1 = \c_six } }

\normalspacedchars{/}

\XeTeXinterchartoks \c_zero \c_one   = { \g_xeCJK_z_to_i_tl }
\XeTeXinterchartoks \c_zero \c_two   = { \g_xeCJK_z_to_ii_tl }
\XeTeXinterchartoks \c_zero \c_three = { \g_xeCJK_z_to_iii_tl }

\XeTeXinterchartoks \c_one \c_zero  = { \egroup \CJKecglue }
\XeTeXinterchartoks \c_one \c_one   = { \g_xeCJK_i_to_i:n }
\XeTeXinterchartoks \c_one \c_two   = { \g_xeCJK_i_to_ii:n }
\XeTeXinterchartoks \c_one \c_three = { \g_xeCJK_i_to_iii:n }
\XeTeXinterchartoks \c_one \c_four  = { \egroup \CJKecglue}
\XeTeXinterchartoks \c_one \c_five  = { \egroup }
\XeTeXinterchartoks \c_one \c_six   = { \g_xeCJK_i_to_vi_tl }

\XeTeXinterchartoks \c_two \c_zero  = { \g_xeCJK_ii_to_z_tl }
\XeTeXinterchartoks \c_two \c_one   = { \g_xeCJK_ii_to_i_tl }
\XeTeXinterchartoks \c_two \c_two   = { \g_xeCJK_ii_to_ii:n }
\XeTeXinterchartoks \c_two \c_three = { \g_xeCJK_ii_to_iii:n }
\XeTeXinterchartoks \c_two \c_four  = { \g_xeCJK_ii_to_iv_tl }
\XeTeXinterchartoks \c_two \c_five  = { \g_xeCJK_ii_to_v_tl }
\XeTeXinterchartoks \c_two \c_six   = { \g_xeCJK_ii_to_vi_tl }

\XeTeXinterchartoks \c_three \c_zero  = { \g_xeCJK_iii_to_z_tl }
\XeTeXinterchartoks \c_three \c_one   = { \g_xeCJK_iii_to_i_tl }
\XeTeXinterchartoks \c_three \c_two   = { \g_xeCJK_iii_to_ii:n }
\XeTeXinterchartoks \c_three \c_three = { \g_xeCJK_iii_to_iii:n }
\XeTeXinterchartoks \c_three \c_four  = { \g_xeCJK_iii_to_iv_tl }
\XeTeXinterchartoks \c_three \c_five  = { \g_xeCJK_iii_to_v_tl }
\XeTeXinterchartoks \c_three \c_six   = { \g_xeCJK_iii_to_vi_tl }

\XeTeXinterchartoks \c_four \c_one   = { \g_xeCJK_iv_to_i_tl }
\XeTeXinterchartoks \c_four \c_two   = { \g_xeCJK_iv_to_ii_tl }
\XeTeXinterchartoks \c_four \c_three = { \g_xeCJK_iv_to_iii_tl }

\XeTeXinterchartoks \c_five \c_one   = { \g_xeCJK_v_to_i_tl }
\XeTeXinterchartoks \c_five \c_two   = { \g_xeCJK_v_to_ii_tl }
\XeTeXinterchartoks \c_five \c_three = { \g_xeCJK_v_to_iii_tl }

\XeTeXinterchartoks \c_six   \c_one   = { \g_xeCJK_vi_to_i_tl }
\XeTeXinterchartoks \c_six   \c_two   = { \g_xeCJK_vi_to_ii_tl }
\XeTeXinterchartoks \c_six   \c_three = { \g_xeCJK_vi_to_iii_tl }

\XeTeXinterchartoks \c_zero  \c_two_hundred_fifty_five = { \g_xeCJK_z_to_cclv_tl }
\XeTeXinterchartoks \c_one   \c_two_hundred_fifty_five = { \g_xeCJK_i_to_cclv_tl}
\XeTeXinterchartoks \c_two   \c_two_hundred_fifty_five = { \g_xeCJK_ii_to_cclv_tl }
\XeTeXinterchartoks \c_three \c_two_hundred_fifty_five = { \g_xeCJK_iii_to_cclv_tl }
\XeTeXinterchartoks \c_five  \c_two_hundred_fifty_five = { \g_xeCJK_v_to_cclv_tl }

\XeTeXinterchartoks \c_two_hundred_fifty_five \c_zero  = { \g_xeCJK_cclv_to_z_tl }
\XeTeXinterchartoks \c_two_hundred_fifty_five \c_one   = { \g_xeCJK_cclv_to_i_tl }
\XeTeXinterchartoks \c_two_hundred_fifty_five \c_two   = { \g_xeCJK_cclv_to_ii_tl }
\XeTeXinterchartoks \c_two_hundred_fifty_five \c_three = { \g_xeCJK_cclv_to_iii_tl }
\XeTeXinterchartoks \c_two_hundred_fifty_five \c_four  = { \g_xeCJK_cclv_to_iv_tl }

\tl_set:Nn \g_xeCJK_vi_to_i_tl
  { \bgroup  \xeCJK_emptyCJKtoks: \xeCJK_setfont:  \CJKsymbol }
\tl_set:Nn \g_xeCJK_i_to_vi_tl { \egroup }
\tl_set_eq:NN \g_xeCJK_ii_to_vi_tl  \g_xeCJK_i_to_vi_tl
\tl_set_eq:NN \g_xeCJK_iii_to_vi_tl \g_xeCJK_i_to_vi_tl
\tl_set_eq:NN \g_xeCJK_vi_to_ii_tl  \g_xeCJK_vi_to_i_tl
\tl_set_eq:NN \g_xeCJK_vi_to_iii_tl \g_xeCJK_vi_to_i_tl
\cs_set_nopar:Nn \g_xeCJK_i_to_i:n {
  \bool_if:NTF \l_xeCJK_checksingle_bool
    { \xeCJK_checksingle:n { #1 } } { \CJKglue \CJKsymbol { #1 } }
}
\cs_set_nopar:Nn \g_xeCJK_i_to_ii:n {
  \xeCJK_punctrule:nn { #1 } { l }
  \skip_horizontal:n {
    \use:c { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/lglue_#1 }
    \@plus 0.1 em \@minus 0.1 em }
  \xeCJK_setprepunct:n { #1 }
}
\cs_set_nopar:Nn \g_xeCJK_i_to_iii:n {
  \xeCJK_punctrule:nn { #1 } { r }
  \tl_if_in:NnT \l_xeCJK_specialpunct_tl { #1 } { \CJKglue } { \nobreak }
  \tl_gset:Nx \xeCJK_lastpunct_tl { #1 }  \CJKpunctsymbol{ #1 }
}
\cs_set_nopar:Nn \xeCJK_setprepunct:n {
  \tl_set:Nx \xeCJK_lastpunct_tl { #1 }
  \tex_vrule:D \@width \use:c
    { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/lrule_#1 }
    \@depth \c_zero_dim \@height \c_zero_dim \scan_stop:
  \CJKpunctsymbol { #1 }
}
\tl_set:Nn \g_xeCJK_i_to_cclv_tl
  { \egroup  { \xeCJK_CJKkern: }  \xeCJK_ignorespaces: }
\tl_set:Nn \g_xeCJK_ii_to_i_tl { \nobreak \CJKsymbol }
\cs_set_nopar:Nn \g_xeCJK_ii_to_ii:n {
  \nobreak  \xeCJK_punctrule:nn { #1 } { l }
  \xeCJK_setkern:nn { \xeCJK_lastpunct_tl } { #1 }
  \tex_kern:D \use:c
    { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/kern_\xeCJK_lastpunct_tl _#1 }
  \xeCJK_setprepunct:n { #1 }
}
\cs_set_nopar:Nn \g_xeCJK_ii_to_iii:n {
  \nobreak  \xeCJK_punctrule:nn { #1 } { r }
  \xeCJK_setkern:nn { \xeCJK_lastpunct_tl } { #1 }
  \tex_kern:D \use:c
    { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/kern_\xeCJK_lastpunct_tl _#1 }
  \nobreak  \tl_set:Nx \xeCJK_lastpunct_tl { #1 }  \CJKpunctsymbol { #1 }
}
\tl_set:Nn \g_xeCJK_ii_to_z_tl { \nobreak \egroup }
\cs_set_eq:NN \g_xeCJK_ii_to_iv_tl \g_xeCJK_ii_to_z_tl
\cs_set_eq:NN \g_xeCJK_ii_to_v_tl  \g_xeCJK_ii_to_z_tl
\tl_set:Nn \g_xeCJK_ii_to_cclv_tl { \nobreak \egroup \tex_ignorespaces:D }
\tl_set:Nn \g_xeCJK_iii_to_z_tl { \xeCJK_afterpostpunct: \egroup }
\tl_set:Nn \g_xeCJK_iii_to_i_tl { \xeCJK_afterpostpunct: \CJKsymbol }
\cs_set_nopar:Nn \g_xeCJK_iii_to_ii:n {
  \tex_vrule:D \@width \use:c
    { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/rrule_\xeCJK_lastpunct_tl }
    \@depth \c_zero_dim \@height \c_zero_dim \scan_stop:
  \xeCJK_punctrule:nn { #1 } { l }
  \xeCJK_setkern:nn { \xeCJK_lastpunct_tl } { #1 }
  \tex_kern:D \use:c
    { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/kern_\xeCJK_lastpunct_tl _#1 }
  \xeCJK_punct_nobreak:
  \xeCJK_setprepunct:n { #1 }
}
\cs_set_nopar:Nn \g_xeCJK_iii_to_iii:n {
  \tex_vrule:D \@width \use:c
    { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/rrule_\xeCJK_lastpunct_tl }
    \@depth \c_zero_dim \@height \c_zero_dim \scan_stop:
  \xeCJK_punctrule:nn { #1 } { r }
  \xeCJK_setkern:nn { \xeCJK_lastpunct_tl } { #1 }
  \tex_kern:D \use:c
    { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/kern_\xeCJK_lastpunct_tl _#1 }
  \nobreak  \tl_set:Nx \xeCJK_lastpunct_tl { #1 }  \CJKpunctsymbol { #1 }
}
\tl_set:Nn \g_xeCJK_iii_to_iv_tl { \xeCJK_afterpostpunct: \egroup }
\cs_set_nopar:Nn \xeCJK_afterpostpunct: {
  \tex_vrule:D \@width \use:c
    { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/rrule_\xeCJK_lastpunct_tl}
    \@depth \c_zero_dim \@height \c_zero_dim \scan_stop:
  \skip_horizontal:n { \use:c
    { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/rglue_\xeCJK_lastpunct_tl }
    \@plus 0.1 em \@minus 0.1 em }
}
\tl_set_eq:NN \g_xeCJK_iii_to_v_tl \g_xeCJK_iii_to_iv_tl
\tl_set:Nn \g_xeCJK_iii_to_cclv_tl
  { \xeCJK_afterpostpunct:  \egroup  \tex_ignorespaces:D }
\tl_set:Nn \g_xeCJK_z_to_i_tl
  { \CJKecglue \bgroup \xeCJK_setfont: \xeCJK_emptyCJKtoks: \CJKsymbol }
\tl_set:Nn \g_xeCJK_z_to_ii_tl {
  \bgroup  \xeCJK_setfont:
  \XeTeXinterchartoks \c_zero \c_two = { \c_empty_tl }
  \xeCJK_emptyCJKtoks:  \g_xeCJK_i_to_ii:n
}
\tl_set:Nn \g_xeCJK_z_to_iii_tl {
  \bgroup  \xeCJK_setfont:
  \XeTeXinterchartoks \c_zero \c_three = { \c_empty_tl }
  \xeCJK_emptyCJKtoks:  \g_xeCJK_i_to_iii:n
}
\tl_set:Nn \g_xeCJK_iv_to_i_tl {
  \bgroup  \xeCJK_setfont:
  \XeTeXinterchartoks \c_four \c_one = { \c_empty_tl }
  \xeCJK_emptyCJKtoks:  \CJKsymbol
}
\tl_set:Nn \g_xeCJK_iv_to_ii_tl {
  \bgroup  \xeCJK_setfont:
  \XeTeXinterchartoks \c_four \c_two = { \c_empty_tl }
  \xeCJK_emptyCJKtoks:  \g_xeCJK_i_to_ii:n
}
\tl_set:Nn \g_xeCJK_iv_to_iii_tl {
  \bgroup  \xeCJK_setfont:
  \XeTeXinterchartoks \c_four \c_three { \c_empty_tl }
  \xeCJK_emptyCJKtoks:  \g_xeCJK_i_to_iii:n
}
\tl_set:Nn \g_xeCJK_v_to_i_tl {
  \CJKecglue  \bgroup  \xeCJK_setfont:
  \xeCJK_emptyCJKtoks:  \CJKsymbol
}
\tl_set:Nn \g_xeCJK_v_to_ii_tl {
  \bgroup \xeCJK_setfont:
  \XeTeXinterchartoks \c_five \c_two = { \c_empty_tl }
  \xeCJK_emptyCJKtoks: \g_xeCJK_i_to_ii:n
}
\tl_set:Nn \g_xeCJK_v_to_iii_tl {
  \bgroup \xeCJK_setfont:
  \XeTeXinterchartoks \c_five \c_three = { \c_empty_tl }
  \xeCJK_emptyCJKtoks: \g_xeCJK_i_to_iii:n
}
\cs_set_nopar:Nn \xeCJK_emptyCJKtoks: {
  \XeTeXinterchartoks \c_two_hundred_fifty_five \c_one   = { \c_empty_tl }
  \XeTeXinterchartoks \c_two_hundred_fifty_five \c_two   = { \c_empty_tl }
  \XeTeXinterchartoks \c_two_hundred_fifty_five \c_three = { \c_empty_tl }
}
\tl_set:Nn \g_xeCJK_z_to_cclv_tl
  { \peek_meaning:NF \c_space_token  { \xeCJK_zerokern: } }

\tl_set_eq:NN \g_xeCJK_v_to_cclv_tl \g_xeCJK_z_to_cclv_tl
\tl_set:Nn \g_xeCJK_cclv_to_z_tl {
  \int_compare:nT { \tex_lastkern:D = \c_one } { \c_space_token } %\CJKecglue
}
\tl_set_eq:NN \g_xeCJK_cclv_to_iv_tl \g_xeCJK_cclv_to_z_tl
\tl_set:Nn \g_xeCJK_cclv_to_i_tl {
  \group_begin:
    \int_compare:nTF { \tex_lastkern:D = \c_one } { \CJKglue } {
    \int_compare:nTF { \tex_lastkern:D = \c_four } { \c_space_token } {
    \int_compare:nT  { \etex_lastnodetype:D = \c_ten } { \CJKecglue } } }
  \group_end:
  \bgroup  \xeCJK_emptyCJKtoks:  \xeCJK_setfont:  \CJKsymbol
}

\tl_set:Nn \g_xeCJK_cclv_to_ii_tl
  { \bgroup \xeCJK_emptyCJKtoks: \xeCJK_setfont: \g_xeCJK_i_to_ii:n }
\tl_set:Nn \g_xeCJK_cclv_to_iii_tl
  { \bgroup \xeCJK_emptyCJKtoks: \xeCJK_setfont: \g_xeCJK_i_to_iii:n }

\cs_new_nopar:Npn \CJKglue
  { \skip_horizontal:n { \c_zero_skip \@plus .08\baselineskip } }
\cs_set_nopar:Nn \CJK_nobreakglue: { \nobreak \CJKglue \nobreak }

\cs_set_nopar:Nn \xeCJK_CJKkern:      { \tex_kern:D -1 sp  \tex_kern:D 1 sp }
\cs_set_nopar:Nn \xeCJK_prepunctkern: { \tex_kern:D -2 sp  \tex_kern:D 2 sp }
\cs_set_nopar:Nx \xeCJK_zerokern:     { \tex_kern:D -4 sp  \tex_kern:D 4 sp }

\cs_set_nopar:Nn \xeCJK_ignorespaces: {
  \peek_meaning:NTF \c_space_token {
    \bool_if:NF \l_xeCJK_space_bool {
      \peek_meaning_ignore_spaces:NTF $ { \c_space_token } {
        \peek_charcode_ignore_spaces:NT \scan_stop: { \c_space_token }
      }
    }
  }{
    \peek_meaning:NT $ { \CJKecglue }
  }
}

\cs_set_eq:NN \xeCJK_par \par

\cs_set_nopar:Nn \xeCJK_checksingle:n {
  \tl_set:Nn \xeCJK_setcurrentchar_i_tl
    { \CJKglue \CJKsymbol { #1 } }
  \tl_set:Nn \xeCJK_setcurrentnobreakchar_i_tl { \CJKsymbol{ #1 } }
  \peek_catcode:NTF 。
    { \xeCJK_checksingle_iii:n }{ \xeCJK_setcurrentchar_i_tl }
}

\cs_set_nopar:Nn \xeCJK_checksingle_iii:n {
  \tl_set:Nn \l_xeCJKsetcurrentchar_ii_tl   { \xeCJK_setcurrentchar_i_tl #1 }
  \tl_set:Nn \l_xeCJKsetcurrentchar_ii_s_tl { \xeCJK_setcurrentchar_i_tl #1 }
  \tl_set:Nn \l_xeCJK_setcurrentnobreakchar_ii_tl
    { \xeCJK_setcurrentnobreakchar_i_tl #1 }
  \peek_meaning:NTF \c_space_token {
    \peek_meaning_ignore_spaces:NTF \xeCJK_par
     { \l_xeCJK_setcurrentnobreakchar_ii_tl }
     { \l_xeCJKsetcurrentchar_ii_s_tl }
  }
  { \l_xeCJKsetcurrentchar_ii_tl }
}

\tl_put_left:Nn \/ {
  \scan_stop:
  \int_compare:nT { \tex_lastkern:D = \c_four }
    { \tex_unkern:D \tex_unkern:D }
}

\cs_if_free:NT \XeTeXglyphbounds {
  \PackageError { xeCJK } { ^^J
    \token_to_str:N \XeTeXglyphbounds\c_space_tl not~ defined.^^J
    You~ have~ to~ update~ XeTeX~ to~ the~ version~ 0.9995.0~ or~ later. }
}

\dim_zero_new:N \l_xeCJK_tmpa_dim

\bool_new:N \l_xeCJK_punct_dokerning_bool

\cs_set_nopar:Nn \xeCJK_punctrule:nn {
  \tl_gset:Nx \l_xeCJK_bboxname_tl { \l_xeCJK_family_tl/\f@series/\f@shape/\f@size }
  \cs_if_free:cT { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/#2rule_#1 } {
    \cs_if_free:cT { xeCJK_\l_xeCJK_bboxname_tl _#2space_#1 }
      { { \xeCJK_setfont:  \xeCJK_setpunctbounds:n { #1 } } }
    \bool_set_true:N \l_xeCJK_punct_dokerning_bool
    \tl_if_eq:NNTF \l_xeCJK_punctstyle_tl \c_xeCJK_ps_plain_tl
      { \bool_set_false:N \l_xeCJK_punct_dokerning_bool }
      { \tl_if_in:NnT \l_xeCJK_specialpunct_tl { #1 }
          { \bool_set_false:N \l_xeCJK_punct_dokerning_bool } }
    \bool_if:NTF \l_xeCJK_punct_dokerning_bool {
      \dim_set:Nn \l_tmpa_dim { \use:c { xeCJK_\l_xeCJK_bboxname_tl _#2space_#1 } }
      \str_if_eq:xxTF { #2 } { l }
        { \dim_set:Nn \l_xeCJK_tmpa_dim { \use:c { xeCJK_\l_xeCJK_bboxname_tl _rspace_#1 } } }
        { \dim_set:Nn \l_xeCJK_tmpa_dim { \use:c { xeCJK_\l_xeCJK_bboxname_tl _lspace_#1 } } }
      \dim_compare:nT { \l_xeCJK_tmpa_dim > \l_tmpa_dim }
        { \dim_set_eq:NN \l_xeCJK_tmpa_dim \l_tmpa_dim }
      \dim_set_eq:NN \l_tmpb_dim \l_tmpa_dim
      \prg_case_tl:Nnn \l_xeCJK_punctstyle_tl {
        \c_xeCJK_ps_halfwidth_tl
          { \dim_set:Nn \l_tmpb_dim { \l_xeCJK_tmpa_dim } }
        \c_xeCJK_ps_mixedwidth_tl {
          \tl_if_in:NnTF \l_xeCJK_kaimingpunct_tl { #1 }
            { \dim_set:Nn \l_tmpb_dim { \l_xeCJK_tmpa_dim + .5\l_tmpb_dim } }
            { \dim_set:Nn \l_tmpb_dim { \l_xeCJK_tmpa_dim  }  } }
        \c_xeCJK_ps_CCT_tl {
          \tl_if_in:NnTF \l_xeCJK_kaimingpunct_tl { #1 }
            { \dim_set:Nn \l_tmpb_dim { \l_xeCJK_tmpa_dim + .5\l_tmpb_dim } }
            { \dim_set:Nn \l_tmpb_dim { \l_xeCJK_tmpa_dim + .2\l_tmpb_dim } } }
      } { \scan_stop: }
      \dim_set_eq:NN \l_tmpc_dim \l_tmpb_dim
      \dim_compare:nT { \l_tmpb_dim < \c_zero_dim } { \dim_zero:N \l_tmpb_dim }
    }{
      \dim_zero:N \l_tmpa_dim  \dim_zero:N \l_tmpb_dim  \dim_zero:N \l_tmpc_dim
    }
    \tl_gset:cx { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/#2rule_#1 }
      { - \dim_use:N \l_tmpa_dim }
    \tl_gset:cx { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/#2glue_#1 }
      { \dim_use:N \l_tmpb_dim }
    \tl_gset:cx { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/#2oglue_#1 }
      { \dim_use:N \l_tmpc_dim }
  }
}

\cs_set_nopar:Nn \xeCJK_setkern:nn {
  \cs_if_free:cT { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/kern_#1_#2 } {
    \dim_zero:N \l_xeCJK_tmpa_dim
    \cs_if_exist:cT { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/roglue_#1 } {
      \dim_add:Nn \l_xeCJK_tmpa_dim
        { \use:c { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/roglue_#1 } } }
    \cs_if_exist:cT { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/loglue_#2 } {
      \dim_add:Nn \l_xeCJK_tmpa_dim
        { \use:c { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/loglue_#2 } } }
    \prg_case_tl:Nnn \l_xeCJK_punctstyle_tl {
      \c_xeCJK_ps_CCT_tl        { \dim_sub:Nn \l_xeCJK_tmpa_dim { .5\l_xeCJK_tmpa_dim } }
      \c_xeCJK_ps_fullwidth_tl  { \dim_sub:Nn \l_xeCJK_tmpa_dim { .5\l_xeCJK_tmpa_dim } }
      \c_xeCJK_ps_mixedwidth_tl { \dim_sub:Nn \l_xeCJK_tmpa_dim { .5\l_xeCJK_tmpa_dim } }
     } { \scan_stop: }
     \dim_compare:nT { \l_xeCJK_tmpa_dim < \c_zero_dim } { \dim_zero:N \l_xeCJK_tmpa_dim }
     \tl_gset:cx { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/kern_#1_#2 }
       { \dim_use:N \l_xeCJK_tmpa_dim }
  }
}

\NewDocumentCommand \xeCJKsetkern  { m m m } {
  \tl_gset:Nx \l_xeCJK_bboxname_tl { \l_xeCJK_family_tl/\f@series/\f@shape/\f@size }
  \tl_gset:cx { xeCJK/\l_xeCJK_punctstyle_tl/\l_xeCJK_bboxname_tl/kern_#1_#2 } { #3 }
}

\cs_set_nopar:Nn \xeCJK_getglyphbounds:nn {
  \int_set:Nn \l_tmpa_int { #1 }
  \int_set:Nn \l_tmpb_int { \XeTeXcharglyph `#2 }
  \dim_set:Nn \l_xeCJK_tmpa_dim { \XeTeXglyphbounds \l_tmpa_int \l_tmpb_int }
}

\cs_set:Nn \xeCJK_setpunctbounds:n {
  \xeCJK_getglyphbounds:nn { \c_one } { #1 }
  \tl_gset:cx { xeCJK_\l_xeCJK_bboxname_tl _lspace_#1 } { \dim_use:N \l_xeCJK_tmpa_dim }
  \xeCJK_getglyphbounds:nn { \c_three } { #1 }
  \tl_gset:cx { xeCJK_\l_xeCJK_bboxname_tl _rspace_#1 } { \dim_use:N \l_xeCJK_tmpa_dim }
  \tl_if_in:NnT \l_xeCJK_specialpunct_tl { #1 } { \str_if_eq:xxF { #1 } { … } {
    \xeCJK_getglyphbounds:nn { \c_one } { #1 }
    \dim_set_eq:NN \l_tmpa_dim \l_xeCJK_tmpa_dim
    \xeCJK_getglyphbounds:nn { \c_three } { #1 }
    \dim_add:Nn \l_xeCJK_tmpa_dim { \l_tmpa_dim }
    \clist_map_inline:Nn \g_xeCJK_punctstyle_clist {
      \tl_gset:cx { xeCJK##1\l_xeCJK_bboxname_tl _kern_#1_#1 }
        { - \dim_use:N \l_xeCJK_tmpa_dim } }
    }
  }
}

\cs_new_nopar:Npn \CJKsymbol      #1 { #1 }
\cs_new_nopar:Npn \CJKpunctsymbol #1 { #1 }

\cs_set_protected_nopar:Nn \xeCJK_ULprepunctchar:n {
  { \XeTeXinterchartokenstate = \c_zero
     \CJKpunctsymbol { #1 }  \nobreak }
   \tex_ignorespaces:D
}
\cs_set_protected_nopar:Nn \xeCJK_ULpostpunctchar:n {
  { \XeTeXinterchartokenstate = \c_zero  \CJKpunctsymbol { #1 } }
  \xeCJK_ignorespaces:
}
\cs_set_protected_nopar:Nn \xeCJK_ULroutines: {
  \XeTeXinterchartoks \c_zero \c_one = { \CJKecglue \CJKsymbol }
  \XeTeXinterchartoks \c_four \c_one = { \CJKsymbol }
  \XeTeXinterchartoks \c_five \c_one = { \CJKecglue \CJKsymbol }
  \XeTeXinterchartoks \c_zero \c_two = { \xeCJK_ULprepunctchar:n }
  \XeTeXinterchartoks \c_four \c_two = { \xeCJK_ULprepunctchar:n }
  \XeTeXinterchartoks \c_five \c_two = { \xeCJK_ULprepunctchar:n }
  \XeTeXinterchartoks \c_zero \c_three = { \xeCJK_ULpostpunctchar:n }
  \XeTeXinterchartoks \c_four \c_three = { \xeCJK_ULpostpunctchar:n }
  \XeTeXinterchartoks \c_five \c_three = { \xeCJK_ULpostpunctchar:n }
  \XeTeXinterchartoks \c_two_hundred_fifty_five \c_one   { \g_xeCJK_cclv_to_i_tl  }
  \XeTeXinterchartoks \c_two_hundred_fifty_five \c_two   { \xeCJK_ULprepunctchar:n }
  \XeTeXinterchartoks \c_two_hundred_fifty_five \c_three { \xeCJK_ULpostpunctchar:n }
}

\AtBeginDocument {
  \cs_if_exist:NT \UL@hook {
    \addto@hook \UL@hook {
      \cs_set_eq:NN \xeCJK_UL_CJKsymbol \CJKsymbol
      \cs_set_eq:NN \xeCJK_UL_CJKpunctsymbol \CJKpunctsymbol
      \cs_set_nopar:Npn \CJKsymbol #1 {
        { \xeCJK_setfont: \xeCJK_UL_CJKsymbol { #1 } }
        \xeCJK_CJKkern: \xeCJK_ignorespaces:  }
      \cs_set_nopar:Npn \CJKpunctsymbol #1
        { { \xeCJK_setfont: \xeCJK_UL_CJKpunctsymbol { #1 } } }
      \xeCJK_ULroutines: } }
  \cs_if_exist:cT { ver@CJKfntef.sty } {
    \tl_set:Nn \XeTeX@CJKfntef@hook
      { \xeCJK_setfont:  \XeTeXinterchartokenstate = \c_zero } }
}

\cs_new_nopar:Nn \xeCJK_setfont: {
  \cs_if_exist_use:cF { xeCJK/\l_xeCJK_family_tl/\f@series/\f@shape/\f@size } {
    \tl_set:Nx \l_xeCJK_currentcoor_tl
      { xeCJK/\l_xeCJK_family_tl/\f@series/\f@shape/\f@size }
    \use:c { xeCJK_font_\l_xeCJK_family_tl }
    \group_begin:
      \get@external@font
      \exp_args:Nx
    \group_end:
    { \exp_args:NNc \tex_global:D \tex_font:D { \l_xeCJK_currentcoor_tl } = \external@font }
  }
}

\cs_if_free:NT \CJKrmdefault
  { \tl_set:Nn \CJKrmdefault { rm } }
\NewDocumentCommand \setCJKmainfont { O{} m }
  { \xeCJK_newfontfamily:nnn { \CJKrmdefault } { #1 } { #2 } }
\@onlypreamble \setCJKmainfont

\cs_new_eq:NN \setCJKromanfont \setCJKmainfont
\@onlypreamble \setCJKromanfont

\cs_if_free:NT \CJKsfdefault
  { \tl_set:Nn \CJKsfdefault { sf } }
\NewDocumentCommand \setCJKsansfont { O{} m }
  { \xeCJK_newfontfamily:nnn { \CJKsfdefault } { #1 } { #2 } }
\@onlypreamble \setCJKsansfont

\cs_if_free:NT \CJKttdefault
  { \tl_set:Nn \CJKttdefault { tt } }

\tl_set:Nn \CJKfamilydefault { \CJKrmdefault }

\RenewDocumentCommand \normalfont { } {
  \CJKfamily \CJKfamilydefault
  \usefont \encodingdefault \familydefault
    \seriesdefault \shapedefault \scan_stop:
}
\cs_set_eq:NN \reset@font \normalfont

\RenewDocumentCommand \rmfamily { } {
  \not@math@alphabet \rmfamily \mathrm
  \fontfamily \rmdefault  \CJKfamily \CJKrmdefault
  \selectfont
}

\RenewDocumentCommand \sffamily { } {
  \not@math@alphabet \sffamily \mathsf
  \fontfamily \sfdefault  \CJKfamily \CJKsfdefault
  \selectfont
}

\RenewDocumentCommand \ttfamily { } {
  \not@math@alphabet \ttfamily \mathtt
  \fontfamily \ttdefault  \CJKfamily \CJKttdefault
  \selectfont
}

\cs_new_nopar:Nn \xeCJK_fallback_testsymbol:n {
  \etex_iffontchar:D \tex_font:D `#1 \scan_stop:
    #1
  \else:
    { \cs_if_exist_use:cTF { xeCJK_fallback_\l_xeCJK_family_tl } { #1 } { ■ } }
  \fi:
}
\NewDocumentCommand \xeCJKenablefallback { } {
  \cs_set_eq:NN \xeCJK_fallback_CJKsymbol \CJKsymbol
  \cs_set_nopar:Npn \CJKsymbol ##1
    { \xeCJK_fallback_CJKsymbol { \xeCJK_fallback_testsymbol:n { ##1 } } }
}
\NewDocumentCommand \xeCJKdisablefallback { }
  { \cs_set_eq:NN \CJKsymbol \xeCJK_fallback_CJKsymbol }
\bool_if:NT \g_xeCJK_AutoFallBack_bool { \xeCJKenablefallback }

\NewDocumentCommand \setCJKfallbackfamilyfont { m O{} m } {
  \exp_args:Nc \newfontfamily { xeCJK_fallback_#1 } [ #2 ] { #3 }
}

\cs_if_free:NT \keys_set_known:nxN
  { \cs_generate_variant:Nn \keys_set_known:nnN { nx } }
\cs_new_nopar:Npn \l_xeCJK_fallback:nn [ #1 ] #2 {
  \clist_set:Nx \l_xeCJK_features_fb_clist { #1 }
  \tl_set:Nx \l_xeCJK_fontname_fb_tl { #2 }
}

\keys_define:nn { xeCJK-Features } {
  BoldFont        .tl_set_x:N = \l_xeCJK_fontname_bf_tl,
  ItalicFont      .tl_set_x:N = \l_xeCJK_fontname_it_tl,
  BoldItalicFont  .tl_set_x:N = \l_xeCJK_fontname_bfit_tl,
  SlantedFont     .tl_set_x:N = \l_xeCJK_fontname_sl_tl,
  BoldSlantedFont .tl_set_x:N = \l_xeCJK_fontname_bfsl_tl,
  AutoFakeBold  .choice:,
  AutoFakeBold / false .code:n = { \bool_set_false:N \l_xeCJK_AutoFakeBold_bool },
  AutoFakeBold / unknown .code:n = {
    \bool_set_true:N \l_xeCJK_AutoFakeBold_bool
    \fp_set:Nn \l_xeCJK_EmboldenFactor_fp { \l_keys_value_tl } },
  AutoFakeBold .default:n  = { \g_xeCJK_EmboldenFactor_fp },
  AutoFakeItalic  .choice:,
  AutoFakeItalic / false .code:n = { \bool_set_false:N \l_xeCJK_AutoFakeItalic_bool },
  AutoFakeItalic / unknown .code:n = {
    \bool_set_true:N \l_xeCJK_AutoFakeItalic_bool
    \fp_set:Nn \l_xeCJK_ItalicFactor_fp { \l_keys_value_tl } },
  AutoFakeItalic .default:n  = { \g_xeCJK_ItalicFactor_fp },
  AutoFakeSlant  .choice:,
  AutoFakeSlant / false .code:n = { \bool_set_false:N \l_xeCJK_AutoFakeSlant_bool },
  AutoFakeSlant / unknown .code:n = {
    \bool_set_true:N \l_xeCJK_AutoFakeSlant_bool
    \fp_set:Nn \l_xeCJK_SlantFactor_fp { \l_keys_value_tl } },
  AutoFakeSlant .default:n  = { \g_xeCJK_SlantFactor_fp },
  FallBack .code:n = {
    \tl_set:Nx \l_tmpa_tl { #1 }
    \clist_clear:N \l_xeCJK_features_fb_clist
    \exp_args:No \tl_if_head_eq_charcode:nNTF \l_tmpa_tl [
      { \exp_after:wN \l_xeCJK_fallback:nn \l_tmpa_tl \c_empty_tl }
      { \exp_args:No \tl_if_head_group:nTF \l_tmpa_tl
        { \exp_after:wN \tl_set:Nx \exp_after:wN \l_xeCJK_fontname_fb_tl \l_tmpa_tl }
        { \tl_set:Nx \l_xeCJK_fontname_fb_tl \l_tmpa_tl } }
    \tl_if_empty:NTF \l_xeCJK_fontname_fb_tl
      { \tl_set:Nx \l_xeCJK_fontname_fb_tl \l_xeCJK_fontname_tl }
      { \tl_replace_all:Nnx \l_xeCJK_fontname_fb_tl * \l_xeCJK_fontname_tl }
    \setCJKfallbackfamilyfont { \l_xeCJK_familyname_tl }
      [ \l_xeCJK_features_fb_clist ] { \l_xeCJK_fontname_fb_tl } },
  FallBack .default:n = \c_empty_tl,
  Mono .choice:,
  Mono / Exspace .code:n = { \xeCJK_set_monoexspace: },
  Mono / Scale   .code:n = { \xeCJK_setmonoscale:
    \tl_set:Nx \l_xeCJK_monoscale_tl { Scale = \fp_use:N \g_xeCJK_monoscale_fp } }
}

\cs_new_protected_nopar:Nn \xeCJK_newfontfamily:nnn {
  \tl_set:Nx \l_xeCJK_familyname_tl { #1 }
  \tl_set:Nx \l_xeCJK_fontname_tl { #3 }
  \tl_clear:N \l_xeCJK_monoscale_tl    \tl_clear:N \l_xeCJK_fontname_bf_tl
  \tl_clear:N \l_xeCJK_fontname_it_tl  \tl_clear:N \l_xeCJK_fontname_bfit_tl
  \tl_clear:N \l_xeCJK_fontname_sl_tl  \tl_clear:N \l_xeCJK_fontname_bfsl_tl
  \clist_clear:N \l_xeCJK_features_clist      \clist_clear:N \l_xeCJK_features_aux_clist
  \clist_clear:N \l_xeCJK_features_bfit_clist \clist_clear:N \l_xeCJK_features_bfsl_clist
  \bool_set_eq:NN \l_xeCJK_AutoFakeBold_bool   \g_xeCJK_AutoFakeBold_bool
  \bool_set_eq:NN \l_xeCJK_AutoFakeItalic_bool \g_xeCJK_AutoFakeItalic_bool
  \bool_set_eq:NN \l_xeCJK_AutoFakeSlant_bool  \g_xeCJK_AutoFakeSlant_bool
  \fp_set_eq:NN \l_xeCJK_EmboldenFactor_fp \g_xeCJK_EmboldenFactor_fp
  \fp_set_eq:NN \l_xeCJK_ItalicFactor_fp   \g_xeCJK_ItalicFactor_fp
  \fp_set_eq:NN \l_xeCJK_SlantFactor_fp    \g_xeCJK_SlantFactor_fp
  \keys_set_known:nxN { xeCJK-Features } { #2 } \l_xeCJK_features_clist
  \bool_if:nTF {
    \tl_if_empty_p:N \l_xeCJK_fontname_bf_tl && \l_xeCJK_AutoFakeBold_bool
  }{
    \clist_put_right:Nn \l_xeCJK_features_aux_clist { BoldFont = * }
      \clist_put_right:Nx \l_xeCJK_features_aux_clist
        { BoldFeatures = { FakeBold = \fp_use:N \l_xeCJK_EmboldenFactor_fp } }
  }{
    \clist_put_right:Nx \l_xeCJK_features_aux_clist
      { BoldFont = \l_xeCJK_fontname_bf_tl }
  }
  \bool_if:nTF {
    \tl_if_empty_p:N \l_xeCJK_fontname_it_tl && \l_xeCJK_AutoFakeItalic_bool
  }{
    \clist_put_right:Nn \l_xeCJK_features_aux_clist { ItalicFont = * }
    \clist_put_right:Nx \l_xeCJK_features_aux_clist
      { ItalicFeatures = { FakeSlant = \fp_use:N \l_xeCJK_ItalicFactor_fp } }
  }{
    \clist_put_right:Nx \l_xeCJK_features_aux_clist
      { ItalicFont = \l_xeCJK_fontname_it_tl }
  }
  \bool_if:nTF {
    \tl_if_empty_p:N \l_xeCJK_fontname_sl_tl && \l_xeCJK_AutoFakeSlant_bool
  }{
    \clist_put_right:Nn \l_xeCJK_features_aux_clist { SlantedFont = * }
    \clist_put_right:Nx \l_xeCJK_features_aux_clist
      { SlantedFeatures = { FakeSlant = \fp_use:N \l_xeCJK_SlantFactor_fp } }
  }{
    \clist_put_right:Nx \l_xeCJK_features_aux_clist
      { SlantedFont = \l_xeCJK_fontname_sl_tl }
  }
  \bool_if:nTF {
    \tl_if_empty_p:N \l_xeCJK_fontname_bfit_tl &&
      ( \l_xeCJK_AutoFakeBold_bool || \l_xeCJK_AutoFakeItalic_bool )
  }{
    \clist_put_right:Nn \l_xeCJK_features_aux_clist { BoldItalicFont = * }
    \bool_if:NTF \l_xeCJK_AutoFakeBold_bool {
      \clist_put_right:Nx \l_xeCJK_features_bfit_clist
        { FakeBold = \fp_use:N \l_xeCJK_EmboldenFactor_fp }
    }{
      \clist_put_right:Nx \l_xeCJK_features_bfit_clist
        { FakeSlant = \fp_use:N \l_xeCJK_ItalicFactor_fp }
    }
    \clist_put_right:Nx \l_xeCJK_features_aux_clist
      { BoldItalicFeatures = { \l_xeCJK_features_bfit_clist } }
  }{
    \clist_put_right:Nx \l_xeCJK_features_aux_clist
      { BoldItalicFont = \l_xeCJK_fontname_bfit_tl }
  }
  \bool_if:nTF {
    \tl_if_empty_p:N \l_xeCJK_fontname_bfsl_tl &&
      ( \l_xeCJK_AutoFakeBold_bool || \l_xeCJK_AutoFakeSlant_bool )
  }{
    \clist_put_right:Nn \l_xeCJK_features_aux_clist { BoldSlantedFont = * }
    \bool_if:NTF \l_xeCJK_AutoFakeBold_bool {
      \clist_put_right:Nx \l_xeCJK_features_bfsl_clist
        { FakeBold = \fp_use:N \l_xeCJK_EmboldenFactor_fp }
    }{
      \clist_put_right:Nx \l_xeCJK_features_bfsl_clist
        { FakeSlant = \fp_use:N \l_xeCJK_SlantFactor_fp }
    }
      \clist_put_right:Nx \l_xeCJK_features_aux_clist
        { BoldSlantedFeatures = { \l_xeCJK_features_bfsl_clist } }
  }{
    \clist_put_right:Nx \l_xeCJK_features_aux_clist
      { BoldSlantedFont = \l_xeCJK_fontname_bfsl_tl }
  }
  \clist_if_empty:NF \l_xeCJK_features_aux_clist
    { \clist_put_left:Nx \l_xeCJK_features_clist \l_xeCJK_features_aux_clist }
  \tl_if_empty:NF \l_xeCJK_monoscale_tl
    { \clist_put_right:Nx \l_xeCJK_features_clist \l_xeCJK_monoscale_tl }
  \exp_args:Nc \newfontfamily { xeCJK_font_\l_xeCJK_familyname_tl }
      [ \l_xeCJK_features_clist ] { \l_xeCJK_fontname_tl }  
  \clist_set:cx { xeCJK_fontoptions_\l_xeCJK_familyname_tl } { #2 }
  \tl_set:cx { xeCJK_fontname_\l_xeCJK_familyname_tl } { \l_xeCJK_fontname_tl }
}

\NewDocumentCommand \CJKfamily { m } {
  \cs_if_exist:cTF { xeCJK_font_#1 } {
    \tl_set:Nx \l_xeCJK_family_tl { #1 }
  }{
    \cs_if_exist:cF { xeCJK_warned_aux_#1 } {
      \PackageWarning { xeCJK } {
        Unknown~ CJK~ family~ `#1'~ is~ ignored.^^J
        Use~ \token_to_str:N \setCJKfamilyfont\c_space_tl to~ define~ a~ CJK~ family.
      }
      \tl_gset:cx { xeCJK_warned_aux_#1 } { \c_empty_tl } }
  }
}

\NewDocumentCommand \setCJKfamilyfont { m O{} m }
  { \xeCJK_newfontfamily:nnn { #1 } { #2 } { #3 } }

\NewDocumentCommand \newCJKfontfamily { o m O{} m } {
  \IfNoValueTF { #1 }
    { \tl_set:Nx \l_xeCJK_familyname_tl { \cs_to_str:N #2 } }
    { \tl_set:Nx \l_xeCJK_familyname_tl { #1 } }
  \xeCJK_newfontfamily:nnn { \l_xeCJK_familyname_tl } { #3 } { #4 }
  \cs_new_protected_nopar:Npx #2
    { \exp_not:N \CJKfamily { \l_xeCJK_familyname_tl } }
}

\int_new:N \g_xeCJK_fontspec_int
\NewDocumentCommand \CJKfontspec { O{} m } {
  \int_gincr:N \g_xeCJK_fontspec_int
  \tl_set:Nx \l_xeCJK_family_fontspec_tl
    { xeCJK_family_fontspec_\int_use:N \g_xeCJK_fontspec_int }
  \xeCJK_newfontfamily:nnn { \l_xeCJK_family_fontspec_tl } { #1 } { #2 }
  \exp_args:Nx \CJKfamily { \l_xeCJK_family_fontspec_tl }
}

\NewDocumentCommand \addCJKfontfeatures { m } {
  \cs_if_exist:NT \l_xeCJK_family_tl {
    \clist_put_right:cx { xeCJK_fontoptions_\l_xeCJK_family_tl } { #1 }
    \CJKfontspec [ \clist_use:c { xeCJK_fontoptions_\l_xeCJK_family_tl } ]
      { \tl_use:c { xeCJK_fontname_\l_xeCJK_family_tl } } }
}

\cs_set_eq:NN \addCJKfontfeature \addCJKfontfeatures

\AtBeginDocument { \CJKfamily \CJKfamilydefault }

\dim_set:Nn \parindent { 2 em }

\fp_new:N \g_xeCJK_monoscale_fp
\fp_gset_eq:NN \g_xeCJK_monoscale_fp \c_one_fp

\dim_new:N \g_xeCJK_exspace_dim
\dim_gset_eq:NN \g_xeCJK_exspace_dim \c_zero_dim

\cs_new:Nn \xeCJK_setmonoscale: {
  \dim_gset_eq:NN \g_xeCJK_exspace_dim \c_zero_dim
  \group_begin:
    \fontfamily \ttdefault \selectfont
    \fp_gset_from_dim:Nn \g_xeCJK_monoscale_fp { \c_two\fontdimen\c_two\font }
    \fp_gdiv:Nn \g_xeCJK_monoscale_fp { \f@size }
  \group_end:
}

\NewDocumentCommand \setCJKmonoscale { } {
  \xeCJK_setmonoscale:
  \addCJKfontfeatures { Scale = \fp_use:N \g_xeCJK_monoscale_fp }
}
\@onlypreamble \setCJKmonoscale

\NewDocumentCommand \setCJKmonoscalefont { O{} m }
  { \xeCJK_newfontfamily:nnn { \CJKttdefault } { Mono = Scale, #1 } { #2 } }

\cs_new:Nn \xeCJK_set_monoexspace: {
  \fp_gset_eq:NN \g_xeCJK_monoscale_fp \c_one_fp
  \group_begin:
    \fontfamily \ttdefault \selectfont
    \dim_gset:Nn \g_xeCJK_exspace_dim { \c_two\fontdimen\c_two\font - \f@size\p@ }
  \group_end:
}

\NewDocumentCommand \setCJKmonoexspace { } { \xeCJK_set_monoexspace: }

\cs_new:Nn \xeCJK_fixed_ecglue: { \skip_horizontal:N .5\g_xeCJK_exspace_dim }

\cs_new:Nn \xeCJK_fixed_cjkglue: { \skip_horizontal:N \g_xeCJK_exspace_dim }

\tl_set_eq:NN \l_xeCJK_flexible_punctstyle_tl \l_xeCJK_punctstyle_tl
\cs_set_eq:NN \xeCJK_flexible_ecglue: \CJKecglue
\cs_set_eq:NN \xeCJK_flexible_cjkglue: \CJKglue

\NewDocumentCommand \CJKfixedspacing { m } {
  \tl_if_eq:NNF \l_xeCJK_punctstyle_tl \c_xeCJK_ps_plain_tl {
    \tl_set_eq:NN \l_xeCJK_flexible_punctstyle_tl \l_xeCJK_punctstyle_tl
    \punctstyle { plain }
  }
  \cs_if_eq:NNF \CJKecglue \xeCJK_fixed_ecglue: {
    \cs_set_eq:NN \xeCJK_flexible_ecglue: \CJKecglue
    \cs_set_eq:NN \CJKecglue \xeCJK_fixed_ecglue:
  }
  \cs_if_eq:NNF \CJKglue \xeCJK_fixed_cjkglue: {
    \cs_set_eq:NN \xeCJK_flexible_cjkglue: \CJKglue
    \cs_set_eq:NN \CJKglue \xeCJK_fixed_cjkglue:
  }
}

\NewDocumentCommand \CJKflexiblespacing { m } {
  \cs_set_eq:NN \l_xeCJK_punctstyle_tl \l_xeCJK_flexible_punctstyle_tl
  \cs_set_eq:NN \CJKecglue \xeCJK_flexible_ecglue:
  \cs_set_eq:NN \cjkglue \xeCJK_flexible_cjkglue:
}

\NewDocumentCommand \setCJKmonoexspacefont { O{} m } {
  \xeCJK_newfontfamily:nnn { \CJKttdefault } { Mono = Exspace, #1 } { #2 }
}
\@onlypreamble \setCJKmonoexspacefont

\NewDocumentCommand \setCJKmonofont { s t+ O{} m } {
  \IfBooleanTF { #1 }
    { \setCJKmonoscalefont  [ #3 ] { #4 } }
    { \IfBooleanTF { #2 }
        { \setCJKmonoexspacefont [ #3 ] { #4 } }
        { \xeCJK_newfontfamily:nnn { \CJKttdefault } { #3 } { #4 } }
    }
}
\@onlypreamble \setCJKmonofont

\AtBeginDocument
  { \tl_put_right:Nn \verbatim@font { \CJKfixedspacing } }

\bool_if:NT \l_xeCJK_number_bool {
  \tl_set:Nn \CJK@UnicodeEnc { UTF8 }
  \cs_set_nopar:Npn \CJKaddEncHook #1 #2 {
    \cs_set_nopar:cpn { xeCJK_enc_#1 } { #2 }
  }
  \cs_set_nopar:Npn \Unicode #1#2 {
    \tex_char:D \int_eval:n { #1 * \c_two_hundred_fifty_six + #2 }
  }
  \RequirePackage { CJKnumb }
  \use:c { xeCJK_enc_\CJK@UnicodeEnc }
  \tl_set:Nn \CJK@tenthousand { 万 }
  \tl_set:Nn \CJK@hundredmillion { 亿 }
}

\NewDocumentCommand \xeCJKcaption { o m } {
  \IfValueT { #1 } { \XeTeXdefaultencoding "#1" }
  \makeatletter
  \input { #2.cpx }
  \makeatother
  \XeTeXdefaultencoding "UTF-8"
}

\endlinechar `\^^M
\catcode "FEFF=9\relax
\endinput
%%
%% End of file `xeCJK.sty'.
